<div style="display: flex; justify-content: center;">
    <div class="availability-container">
        <mat-card style="display: flex; justify-content: space-between" [style.background-color]="injected ? '#f5f5f5' : '#ffffff'">
            <mat-card-header>
                <mat-card-title>Gestionar Ocupación</mat-card-title>
                <mat-card-subtitle>Bloquea horarios para clases o mantenimiento</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 10px;">
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Motivo del bloqueo</mat-label>
                        <mat-select [(ngModel)]="occupancyToSave.occupancyTypeId">
                            @for (occupancyType of occupancyTypes; track occupancyType.id) {
                                <mat-option [value]="occupancyType.id">{{ occupancyType.name }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Título de ocupación</mat-label>
                        <input matInput [(ngModel)]="occupancyToSave.title">
                    </mat-form-field>
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Rango de fechas</mat-label>
                        <mat-date-range-input [rangePicker]="picker">
                            <input matStartDate placeholder="Inicio" [(ngModel)]="occupancyToSave.startDate">
                            <input matEndDate placeholder="Fin" [(ngModel)]="occupancyToSave.endDate">
                        </mat-date-range-input>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-date-range-picker #picker></mat-date-range-picker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Hora Inicio</mat-label>
                        <input matInput [matTimepicker]="pickerStart" [(ngModel)]="occupancyToSave.startTimeDate">
                        <mat-timepicker-toggle matIconSuffix [for]="pickerStart"/>
                        <mat-timepicker #pickerStart/>
                    </mat-form-field>
                    <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Hora Fin</mat-label>
                        <input matInput [matTimepicker]="pickerEnd" [(ngModel)]="occupancyToSave.endTimeDate">
                        <mat-timepicker-toggle matIconSuffix [for]="pickerEnd"/>
                        <mat-timepicker #pickerEnd/>
                    </mat-form-field>
                    <div>
                        @if (occupancyToSave.endDate && occupancyToSave.startDate.getTime() !== occupancyToSave.endDate.getTime()) {
                            <mat-chip-listbox multiple [(ngModel)]="occupancyToSave.days">
                                <mat-chip-option [value]="0">D</mat-chip-option>
                                <mat-chip-option [value]="1">L</mat-chip-option>
                                <mat-chip-option [value]="2">M</mat-chip-option>
                                <mat-chip-option [value]="3">X</mat-chip-option>
                                <mat-chip-option [value]="4">J</mat-chip-option>
                                <mat-chip-option [value]="5">V</mat-chip-option>
                                <mat-chip-option [value]="6">S</mat-chip-option>
                            </mat-chip-listbox>
                        }
                    </div>
                </div>
            </mat-card-content>
            <mat-card-actions align="end" style="display: flex; gap: 8px;">
                <button matButton="outlined" [disabled]="savingOccupancy" (click)="cleanOccupancy()">
                    Limpiar
                </button>
                <button matButton="filled" [disabled]="savingOccupancy" (click)="onSaveOccupancy()">
                    <mat-icon>save</mat-icon>
                    <span>Guardar Bloqueo</span>
                </button>
            </mat-card-actions>
        </mat-card>
        <mat-card class="list-card" [style.background-color]="injected ? '#f5f5f5' : '#ffffff'">
            <mat-card-header>
                <mat-card-title>Horarios Ocupados</mat-card-title>
            </mat-card-header>
            <mat-list>
                @if (dataLoaded === 1) {
                    <div style="margin: 8px; overflow: auto;">
                        <table mat-table [dataSource]="occupancies">
                            <ng-container matColumnDef="icon">
                                <th mat-header-cell *matHeaderCellDef style="font-weight: 600; background: #f5f5f5"></th>
                                <td mat-cell *matCellDef="let o">
                                    <div style="display: flex; justify-content: center;">
                                        <mat-icon>{{ o.occupancyType.icon }}</mat-icon>
                                    </div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="title">
                                <th mat-header-cell *matHeaderCellDef style="font-weight: 600; background: #f5f5f5"> Nombre </th>
                                <td mat-cell *matCellDef="let t">
                                    <div style="display: flex; flex-direction: column;">
                                        {{ t.title }}
                                        <small>{{ t.startTime }} - {{ t.endTime }}</small>
                                        @if (t.startDate === t.endDate) {
                                            <small>{{ t.startDate | date: 'dd/MM/yyyy' }}</small>
                                        } @else {
                                            <small>{{ t.startDate | date: 'dd/MM/yyyy' }} - {{ t.endDate | date: 'dd/MM/yyyy' }}</small>
                                        }
                                    </div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="days">
                                <th mat-header-cell *matHeaderCellDef style="font-weight: 600; background: #f5f5f5"> Días </th>
                                <td mat-cell *matCellDef="let t">
                                    {{ t.dayNames.join(', ') }}
                                </td>
                            </ng-container>
                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                        </table>
                    </div>
                } @else if (dataLoaded === 0) {
                    <div style="display: flex; justify-content: center; margin: 20px 0">
                        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
                    </div>
                } @else {
                    <div style="display: flex; flex-direction: column; align-items: center; margin: 20px 0">
                        <mat-icon>search_off</mat-icon>
                        <span>No hay bloqueos configurados.</span>
                    </div>
                }
            </mat-list>
        </mat-card>
    </div>
</div>
